<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Domain Monitor</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Error Boundary Overlay -->
  <div id="error-boundary" class="error-boundary" style="display: none;">
    <div class="error-boundary-content">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <h2>Something went wrong</h2>
      <p id="error-boundary-message">An unexpected error occurred.</p>
      <button class="btn" onclick="window.location.reload()">
        <i class="fa-solid fa-arrows-rotate"></i> Reload Page
      </button>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h2><i class="fa-solid fa-lock"></i> Login Required</h2>
      </div>
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="modal-body">
          <div class="form-group">
            <label for="loginUsername">Username</label>
            <input type="text" id="loginUsername" required autocomplete="username" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="Enter password">
          </div>
          <div id="loginError" class="form-error" style="display: none;"></div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-sign-in-alt"></i> Login
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h2><i class="fa-solid fa-cog"></i> Settings</h2>
        <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-tabs">
          <button class="tab-btn active" data-tab="general">General</button>
          <button class="tab-btn" data-tab="schedule">Schedule</button>
          <button class="tab-btn" data-tab="uptime">Uptime</button>
          <button class="tab-btn" data-tab="retention">Retention</button>
          <button class="tab-btn" data-tab="email">Email</button>
          <button class="tab-btn" data-tab="slack">Slack</button>
          <button class="tab-btn" data-tab="signal">Signal</button>
          <button class="tab-btn" data-tab="webhooks">Webhooks</button>
          <button class="tab-btn" data-tab="apikeys">API Keys</button>
        </div>

        <!-- General Tab -->
        <div class="tab-content active" id="tab-general">
          <h3>General Settings</h3>
          <div class="form-group">
            <label for="settingAlertDays">Expiration Alert Days</label>
            <input type="number" id="settingAlertDays" min="1" max="365" value="30">
            <small>Days before expiration to show warnings</small>
          </div>
          <div class="form-group">
            <label for="settingTimezone">Display Timezone</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <select id="settingTimezone" style="flex:1;"></select>
              <button type="button" class="btn btn-sm" onclick="detectTimezone()" title="Auto-detect from browser">&#x1F310; Detect</button>
            </div>
            <small>All dates and times in the UI, logs, and alerts will use this timezone</small>
          </div>
        </div>

        <!-- Schedule Tab -->
        <div class="tab-content" id="tab-schedule">
          <h3>Auto-Refresh Schedule</h3>
          <div class="form-group">
            <label for="settingCron">Cron Expression</label>
            <input type="text" id="settingCron" placeholder="0 0 * * *">
            <small>Default: 0 0 * * * (daily at midnight)</small>
          </div>
          <div class="schedule-presets">
            <button class="preset-btn" onclick="setCronPreset('0 0 * * *')">Daily</button>
            <button class="preset-btn" onclick="setCronPreset('0 0 * * 0')">Weekly</button>
            <button class="preset-btn" onclick="setCronPreset('0 */6 * * *')">Every 6 hours</button>
            <button class="preset-btn" onclick="setCronPreset('0 */12 * * *')">Every 12 hours</button>
          </div>
        </div>

        <!-- Uptime Monitoring Tab -->
        <div class="tab-content" id="tab-uptime">
          <h3>Uptime Monitoring</h3>
          <p class="info-text">Monitor domain availability with periodic HTTP checks and track response times.</p>
          <div class="form-group">
            <label for="settingUptimeEnabled">
              <input type="checkbox" id="settingUptimeEnabled"> Enable Uptime Monitoring
            </label>
          </div>
          <div class="form-group">
            <label for="settingUptimeInterval">Check Interval (minutes)</label>
            <input type="number" id="settingUptimeInterval" min="1" max="60" value="5">
            <small>How often to check domain availability (1-60 minutes)</small>
          </div>
          <div class="form-group">
            <label for="settingUptimeThreshold">Alert Threshold</label>
            <input type="number" id="settingUptimeThreshold" min="1" max="10" value="3">
            <small>Number of consecutive failures before alerting</small>
          </div>
          <div class="uptime-actions">
            <button class="btn" onclick="runUptimeCheckAll()">
              <i class="fa-solid fa-play"></i> Run Check Now
            </button>
            <button class="btn" onclick="restartUptimeService()">
              <i class="fa-solid fa-rotate"></i> Restart Service
            </button>
          </div>

          <hr style="border-color:var(--border);margin:20px 0;">
          <h3>Health Checks</h3>
          <p class="info-text">Periodic DNS, HTTP, and SSL checks run on a separate schedule from uptime monitoring.</p>
          <div class="form-group">
            <label for="settingHealthCheckEnabled">
              <input type="checkbox" id="settingHealthCheckEnabled" checked> Enable Health Checks
            </label>
          </div>
          <div class="form-group">
            <label for="settingHealthCheckInterval">Health Check Interval (hours)</label>
            <input type="number" id="settingHealthCheckInterval" min="1" max="168" value="24">
            <small>How often to run DNS/HTTP/SSL checks (1-168 hours)</small>
          </div>
        </div>

        <!-- Retention Settings Tab -->
        <div class="tab-content" id="tab-retention">
          <h3>Data Retention</h3>
          <p class="info-text">Configure automatic cleanup of old log entries to manage database size.</p>
          <div class="form-group">
            <label for="settingAutoCleanup">
              <input type="checkbox" id="settingAutoCleanup" checked> Enable Auto Cleanup
            </label>
          </div>
          <div class="form-group">
            <label for="settingAuditRetention">Audit Log Retention (days)</label>
            <input type="number" id="settingAuditRetention" min="7" max="365" value="90">
            <small>Delete audit log entries older than this many days</small>
          </div>
          <div class="form-group">
            <label for="settingHealthRetention">Health Log Retention (days)</label>
            <input type="number" id="settingHealthRetention" min="1" max="90" value="30">
            <small>Delete health check records older than this many days</small>
          </div>
          <div class="retention-stats" id="retentionStats">
            <h4>Current Usage</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">Audit Log Entries</span>
                <span class="stat-value" id="auditLogCount">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Health Log Entries</span>
                <span class="stat-value" id="healthLogCount">-</span>
              </div>
            </div>
          </div>
          <div class="retention-actions">
            <button class="btn" onclick="loadRetentionStats()">
              <i class="fa-solid fa-sync"></i> Refresh Stats
            </button>
            <button class="btn btn-danger" onclick="runManualCleanup()">
              <i class="fa-solid fa-trash"></i> Run Cleanup Now
            </button>
          </div>
        </div>

        <!-- Email Tab -->
        <div class="tab-content" id="tab-email">
          <h3>Email Alert Settings</h3>
          <p class="info-text">SMTP settings must be configured via environment variables (SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_SECURE). See <code>.env.example</code> for details.</p>
          <div class="form-group">
            <label for="settingEmailEnabled">
              <input type="checkbox" id="settingEmailEnabled"> Enable Email Alerts
            </label>
          </div>
          <div class="form-group">
            <label for="settingEmailRecipients">Alert Recipients</label>
            <input type="text" id="settingEmailRecipients" placeholder="admin@example.com, team@example.com">
            <small>Comma-separated email addresses to receive expiration alerts</small>
          </div>
          <div class="form-group">
            <label for="settingAlertDaysEmail">Alert Before Expiration (days)</label>
            <input type="text" id="settingAlertDaysEmail" placeholder="7, 14, 30">
            <small>Send alerts this many days before domains expire (comma-separated)</small>
          </div>
          <div class="form-group">
            <label for="settingTestEmail">Test Email Address</label>
            <div class="input-group">
              <input type="email" id="settingTestEmail" placeholder="your@email.com">
              <button class="btn" onclick="testEmailSettings()">
                <i class="fa-solid fa-paper-plane"></i> Send Test
              </button>
            </div>
          </div>
        </div>

        <!-- Slack Tab -->
        <div class="tab-content" id="tab-slack">
          <h3>Slack Notifications</h3>
          <p class="info-text">Send alerts to a Slack channel via an Incoming Webhook URL. Create one at <strong>api.slack.com/apps</strong> â†’ Incoming Webhooks.</p>
          <div class="form-group">
            <label for="settingSlackEnabled">
              <input type="checkbox" id="settingSlackEnabled"> Enable Slack Notifications
            </label>
          </div>
          <div class="form-group">
            <label for="settingSlackWebhookUrl">Incoming Webhook URL</label>
            <input type="url" id="settingSlackWebhookUrl" placeholder="https://hooks.slack.com/services/T.../B.../...">
            <small>Paste your Slack Incoming Webhook URL here</small>
          </div>
          <div class="form-group">
            <label>Events to Send</label>
            <div class="events-checkboxes" id="slackEventsCheckboxes"></div>
          </div>
          <div class="form-group">
            <button class="btn" onclick="testSlackNotification()">
              <i class="fa-solid fa-paper-plane"></i> Send Test Message
            </button>
          </div>
        </div>

        <!-- Signal Tab -->
        <div class="tab-content" id="tab-signal">
          <h3>Signal Notifications</h3>
          <p class="info-text">Send alerts via Signal using <strong>signal-cli REST API</strong>. You must have a self-hosted <code>signal-cli-rest-api</code> instance running.</p>
          <div class="form-group">
            <label for="settingSignalEnabled">
              <input type="checkbox" id="settingSignalEnabled"> Enable Signal Notifications
            </label>
          </div>
          <div class="form-group">
            <label for="settingSignalApiUrl">signal-cli REST API URL</label>
            <input type="url" id="settingSignalApiUrl" placeholder="http://localhost:8080">
            <small>Base URL of your signal-cli REST API instance</small>
          </div>
          <div class="form-group">
            <label for="settingSignalSender">Sender Phone Number</label>
            <input type="text" id="settingSignalSender" placeholder="+12345678900">
            <small>The registered Signal number that sends the messages</small>
          </div>
          <div class="form-group">
            <label for="settingSignalRecipients">Recipients</label>
            <input type="text" id="settingSignalRecipients" placeholder="+12345678900, +19876543210">
            <small>Comma-separated phone numbers or Signal group IDs</small>
          </div>
          <div class="form-group">
            <label>Events to Send</label>
            <div class="events-checkboxes" id="signalEventsCheckboxes"></div>
          </div>
          <div class="form-group">
            <button class="btn" onclick="testSignalNotification()">
              <i class="fa-solid fa-paper-plane"></i> Send Test Message
            </button>
          </div>
        </div>

        <!-- Webhooks Tab -->
        <div class="tab-content" id="tab-webhooks">
          <h3>Outgoing Webhooks</h3>
          <p class="info-text">POST a JSON payload to any URL when events occur. Each webhook can subscribe to specific events and optionally use an HMAC secret for verification.</p>
          <div id="webhooksList" class="webhooks-list"></div>
          <hr style="border-color:var(--border);margin:16px 0;">
          <h4>Add Webhook</h4>
          <div class="form-group">
            <label for="newWebhookName">Name</label>
            <input type="text" id="newWebhookName" placeholder="My Webhook">
          </div>
          <div class="form-group">
            <label for="newWebhookUrl">URL</label>
            <input type="url" id="newWebhookUrl" placeholder="https://example.com/hook">
          </div>
          <div class="form-group">
            <label for="newWebhookSecret">Secret (optional)</label>
            <input type="password" id="newWebhookSecret" placeholder="Leave blank to auto-generate">
            <small>Used to sign payloads with HMAC-SHA256 (X-Hub-Signature-256 header)</small>
          </div>
          <div class="form-group">
            <label>Events</label>
            <div class="events-checkboxes" id="newWebhookEventsCheckboxes"></div>
          </div>
          <button class="btn btn-add" onclick="addWebhook()">
            <i class="fa-solid fa-plus"></i> Add Webhook
          </button>
        </div>

        <!-- API Keys Tab -->
        <div class="tab-content" id="tab-apikeys">
          <h3>API Key Management</h3>
          <p class="info-text">Manage multiple API keys for load balancing and rotation.</p>
          <div id="apiKeysList" class="api-keys-list"></div>
          <div class="form-group">
            <label for="newApiKeyName">Add New API Key</label>
            <div class="input-group">
              <input type="text" id="newApiKeyName" placeholder="Key name (e.g., Primary)">
              <input type="password" id="newApiKeyValue" placeholder="API key value">
              <button class="btn btn-add" onclick="addApiKey()">
                <i class="fa-solid fa-plus"></i> Add
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('settingsModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">
          <i class="fa-solid fa-save"></i> Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Groups Modal -->
  <div id="groupsModal" class="modal" style="display: none;">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2><i class="fa-solid fa-folder"></i> Manage Groups</h2>
        <button class="modal-close" onclick="closeModal('groupsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="groupsList" class="groups-list"></div>
        <div class="form-group">
          <label>Add New Group</label>
          <div class="input-group">
            <input type="text" id="newGroupName" placeholder="Group name">
            <input type="color" id="newGroupColor" value="#6366f1" class="color-picker">
            <button class="btn btn-add" onclick="addGroup()">
              <i class="fa-solid fa-plus"></i> Add
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tags Modal -->
  <div id="tagsModal" class="modal" style="display: none;">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2><i class="fa-solid fa-tags"></i> Manage Tags</h2>
        <button class="modal-close" onclick="closeModal('tagsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="tagsList" class="tags-list"></div>
        <div class="form-group">
          <label>Add New Tag</label>
          <div class="input-group">
            <input type="text" id="newTagName" placeholder="Tag name">
            <input type="color" id="newTagColor" value="#8b5cf6" class="color-picker">
            <button class="btn btn-add" onclick="addTag()">
              <i class="fa-solid fa-plus"></i> Add
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Domain Details Modal -->
  <div id="domainModal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h2><i class="fa-solid fa-globe"></i> <span id="domainModalTitle">Domain Details</span></h2>
        <button class="modal-close" onclick="closeModal('domainModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="domain-details-grid">
          <div class="detail-section">
            <h4>WHOIS Information</h4>
            <div id="domainWhoisInfo"></div>
          </div>
          <div class="detail-section">
            <h4>Health Status</h4>
            <div id="domainHealthInfo"></div>
          </div>
        </div>
        <div class="detail-section">
          <h4>Group & Tags</h4>
          <div class="domain-organization">
            <div class="form-group">
              <label>Group</label>
              <select id="domainGroupSelect">
                <option value="">No Group</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tags</label>
              <div id="domainTagsSelect" class="tags-select"></div>
            </div>
          </div>
        </div>
        <div class="detail-section">
          <h4>Health Check History</h4>
          <div id="domainHealthHistory" class="health-history"></div>
        </div>
        <div class="detail-section">
          <h4>Response Time Trend</h4>
          <div style="position:relative;height:200px;">
            <canvas id="responseTimeChart"></canvas>
          </div>
          <p id="responseTimeEmpty" style="color:var(--text-muted);font-size:13px;display:none;">No uptime data available for this domain.</p>
        </div>
                <div class="detail-section">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <h4 style="margin:0;">Change History</h4>
            <button class="btn btn-sm" id="loadHistoryBtn" onclick="loadDomainHistory()" style="font-size:12px;padding:4px 10px;">
              <i class="fa-solid fa-clock-rotate-left"></i> Load History
            </button>
          </div>
          <div id="domainChangeHistory" class="health-history" style="max-height:220px;overflow-y:auto;">
            <p style="color:var(--text-muted);font-size:13px;">Click "Load History" to view audit log for this domain.</p>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('domainModal')">Close</button>
        <button class="btn btn-primary" onclick="saveDomainDetails()">
          <i class="fa-solid fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Operations Modal -->
  <div id="bulkOpsModal" class="modal" style="display: none;">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2><i class="fa-solid fa-layer-group"></i> Bulk Operations</h2>
        <button class="modal-close" onclick="closeModal('bulkOpsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="bulk-ops-info">
          <span class="bulk-ops-count" id="bulkOpsCount">0</span> domains selected
        </div>

        <div class="bulk-ops-tabs">
          <button class="bulk-tab-btn active" data-bulk-tab="assign-group">
            <i class="fa-solid fa-folder"></i> Assign Group
          </button>
          <button class="bulk-tab-btn" data-bulk-tab="assign-tags">
            <i class="fa-solid fa-tags"></i> Assign Tags
          </button>
          <button class="bulk-tab-btn" data-bulk-tab="actions">
            <i class="fa-solid fa-bolt"></i> Actions
          </button>
        </div>

        <!-- Assign Group Tab -->
        <div class="bulk-tab-content active" id="bulk-tab-assign-group">
          <div class="form-group">
            <label>Select Group</label>
            <select id="bulkGroupSelect">
              <option value="">No Group (Remove from group)</option>
            </select>
          </div>
          <button class="btn btn-primary btn-block" onclick="bulkAssignGroup()">
            <i class="fa-solid fa-folder-plus"></i> Assign Group to Selected
          </button>
        </div>

        <!-- Assign Tags Tab -->
        <div class="bulk-tab-content" id="bulk-tab-assign-tags">
          <div class="form-group">
            <label>Select Tags to Add</label>
            <div id="bulkTagsSelect" class="bulk-tags-grid"></div>
          </div>
          <div class="bulk-tags-actions">
            <button class="btn btn-primary" onclick="bulkAddTags()">
              <i class="fa-solid fa-plus"></i> Add Tags to Selected
            </button>
            <button class="btn btn-danger" onclick="bulkRemoveTags()">
              <i class="fa-solid fa-minus"></i> Remove Tags from Selected
            </button>
          </div>
        </div>

        <!-- Actions Tab -->
        <div class="bulk-tab-content" id="bulk-tab-actions">
          <div class="bulk-actions-list">
            <button class="btn btn-block" onclick="bulkRefreshWhois()">
              <i class="fa-solid fa-arrows-rotate"></i> Refresh WHOIS Data
            </button>
            <button class="btn btn-block" onclick="bulkCheckHealth()">
              <i class="fa-solid fa-heart-pulse"></i> Run Health Checks
            </button>
            <button class="btn btn-block" onclick="bulkCheckUptime()">
              <i class="fa-solid fa-signal"></i> Run Uptime Checks
            </button>
            <hr>
            <button class="btn btn-danger btn-block" onclick="bulkDeleteDomains()">
              <i class="fa-solid fa-trash"></i> Delete Selected Domains
            </button>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('bulkOpsModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- CSV Import Modal -->
  <div id="importModal" class="modal" style="display: none;">
    <div class="modal-content modal-md">
      <div class="modal-header">
        <h2><i class="fa-solid fa-file-import"></i> Import Domains</h2>
        <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="import-dropzone" id="importDropzone">
          <i class="fa-solid fa-cloud-upload-alt"></i>
          <p>Drag & drop a CSV file here, or click to select</p>
          <input type="file" id="importFile" accept=".csv" onchange="handleFileSelect(event)">
        </div>
        <div class="import-format-info">
          <h4>CSV Format</h4>
          <code>domain,group,tags<br>example.com,Production,"important,client-a"</code>
        </div>
        <div id="importPreview" class="import-preview" style="display: none;"></div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('importModal')">Cancel</button>
        <button class="btn btn-primary" id="importBtn" onclick="processImport()" disabled>
          <i class="fa-solid fa-upload"></i> Import
        </button>
      </div>
    </div>
  </div>

  <!-- Audit Log Modal -->
  <div id="auditModal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h2><i class="fa-solid fa-clipboard-list"></i> Audit Log</h2>
        <button class="modal-close" onclick="closeModal('auditModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="audit-filters">
          <select id="auditEntityFilter">
            <option value="">All Entities</option>
            <option value="domain">Domains</option>
            <option value="group">Groups</option>
            <option value="tag">Tags</option>
            <option value="settings">Settings</option>
          </select>
          <select id="auditActionFilter">
            <option value="">All Actions</option>
            <option value="create">Created</option>
            <option value="update">Updated</option>
            <option value="delete">Deleted</option>
          </select>
          <button class="btn" onclick="loadAuditLog()">
            <i class="fa-solid fa-filter"></i> Filter
          </button>
        </div>
        <div id="auditLogList" class="audit-log-list"></div>
      </div>
    </div>
  </div>


  <!-- Timeline Chart Modal -->
  <div id="timelineModal" class="modal" style="display: none;">
    <div class="modal-content modal-xl">
      <div class="modal-header">
        <h2><i class="fa-solid fa-timeline"></i> Domain Expiration Timeline</h2>
        <button class="modal-close" onclick="closeModal('timelineModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="chart-controls" style="margin-bottom:16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <label style="font-size:13px;color:var(--text-muted);">Show:</label>
          <select id="timelineFilter" onchange="renderTimelineChart()" style="font-size:13px;padding:4px 8px;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:6px;">
            <option value="all">All Domains</option>
            <option value="expiring90">Expiring within 90 days</option>
            <option value="expiring365">Expiring within 1 year</option>
            <option value="errors">Errors only</option>
          </select>
          <span id="timelineCount" style="font-size:13px;color:var(--text-muted);margin-left:auto;"></span>
        </div>
        <div style="position:relative;overflow-x:auto;overflow-y:auto;max-height:60vh;">
          <canvas id="domainTimelineChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- Header -->
    <header class="header">
      <h1><img alt="Domain Monitor" src="favicon.png" /> Domain Monitor</h1>
      <div class="header-actions">
        <span id="connectionStatus" class="connection-status" title="WebSocket Status">
          <i class="fa-solid fa-circle"></i>
        </span>
<button class="btn-icon notification-bell" onclick="toggleNotificationSidebar()" title="Notifications" id="notifBellBtn">
          <i class="fa-solid fa-bell"></i>
          <span class="notif-badge" id="notifBadge" style="display:none;">0</span>
        </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
          <i class="fa-solid fa-sun"></i>
          <i class="fa-solid fa-moon"></i>
        </button>
        <button class="btn btn-refresh" onclick="refreshAll()">
          <i class="fa-solid fa-arrows-rotate"></i> Refresh All
        </button>
        <button class="btn" onclick="openModal('importModal')">
          <i class="fa-solid fa-file-import"></i> Import
        </button>
        <button class="btn btn-export" onclick="exportCSV()">
          <i class="fa-solid fa-file-csv"></i> Export
        </button>
        <div class="dropdown">
          <button class="btn btn-icon" onclick="toggleDropdown('moreMenu')">
            <i class="fa-solid fa-ellipsis-v"></i>
          </button>
          <div id="moreMenu" class="dropdown-menu">
            <a href="#" onclick="openModal('groupsModal'); closeDropdown();">
              <i class="fa-solid fa-folder"></i> Manage Groups
            </a>
            <a href="#" onclick="openModal('tagsModal'); closeDropdown();">
              <i class="fa-solid fa-tags"></i> Manage Tags
            </a>
            <a href="#" onclick="runHealthChecks(); closeDropdown();">
              <i class="fa-solid fa-heart-pulse"></i> Run Health Checks
            </a>
            <a href="#" onclick="openModal('auditModal'); loadAuditLog(); closeDropdown();">
              <i class="fa-solid fa-clipboard-list"></i> Audit Log
            </a>
            <a href="#" onclick="openWidgetCustomizer(); closeDropdown();">
              <i class="fa-solid fa-grip"></i> Customize Dashboard
            </a>
            <hr>
            <a href="#" onclick="openModal('settingsModal'); loadSettings(); closeDropdown();">
              <i class="fa-solid fa-cog"></i> Settings
            </a>
            <a href="#" id="logoutBtn" onclick="handleLogout(); closeDropdown();" style="display: none;">
              <i class="fa-solid fa-sign-out-alt"></i> Logout
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Dashboard Overview -->
    <section class="dashboard-overview">
      <!-- Stats Sidebar -->
      <div class="stats-sidebar">
        <div class="stat-card stat-total">
          <div class="stat-icon"><i class="fa-solid fa-globe"></i></div>
          <div class="stat-content">
            <span class="stat-value" id="totalDomains">0</span>
            <span class="stat-label">Total Domains</span>
          </div>
        </div>
        <div class="stat-card stat-critical" id="expiredCard">
          <div class="stat-icon"><i class="fa-solid fa-circle-exclamation"></i></div>
          <div class="stat-content">
            <span class="stat-value" id="expired">0</span>
            <span class="stat-label">Expired</span>
          </div>
        </div>
        <div class="stat-card stat-urgent">
          <div class="stat-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
          <div class="stat-content">
            <span class="stat-value" id="exp15">0</span>
            <span class="stat-label">Within 15 days</span>
          </div>
        </div>
        <div class="stat-card stat-warning">
          <div class="stat-icon"><i class="fa-solid fa-clock"></i></div>
          <div class="stat-content">
            <span class="stat-value" id="exp30">0</span>
            <span class="stat-label">Within 30 days</span>
          </div>
        </div>
        <div class="stat-card stat-notice">
          <div class="stat-icon"><i class="fa-solid fa-calendar"></i></div>
          <div class="stat-content">
            <span class="stat-value" id="exp90">0</span>
            <span class="stat-label">Within 90 days</span>
          </div>
        </div>
        <div class="stat-card stat-safe">
          <div class="stat-icon"><i class="fa-solid fa-shield-halved"></i></div>
          <div class="stat-content">
            <span class="stat-value" id="exp180">0</span>
            <span class="stat-label">Within 6 months</span>
          </div>
        </div>
      </div>

      <!-- Charts Area - Draggable Grid -->
      <div class="charts-area" id="chartsArea">
        <!-- Row 1: Uptime Status + Critical Alerts + Health Status -->
        <div class="chart-card" data-widget-id="uptime-status" draggable="true">
          <div class="widget-drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></div>
          <h3><i class="fa-solid fa-signal"></i> Site Status</h3>
          <div class="uptime-status-widget">
            <div class="status-big-number up">
              <span class="status-count" id="sitesUpCount">0</span>
              <span class="status-label">Sites Up</span>
            </div>
            <div class="status-big-number down">
              <span class="status-count" id="sitesDownCount">0</span>
              <span class="status-label">Sites Down</span>
            </div>
            <div class="status-big-number unknown">
              <span class="status-count" id="sitesUnknownCount">0</span>
              <span class="status-label">Unknown</span>
            </div>
          </div>
        </div>
        <div class="chart-card chart-card-alerts" data-widget-id="alerts" draggable="true">
          <div class="widget-drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></div>
          <h3><i class="fa-solid fa-triangle-exclamation"></i> Critical Alerts</h3>
          <div id="criticalAlerts" class="alerts-list">
            <div class="no-alerts"><i class="fa-solid fa-check-circle"></i> No critical alerts</div>
          </div>
        </div>
        <div class="chart-card" data-widget-id="health" draggable="true">
          <div class="widget-drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></div>
          <h3><i class="fa-solid fa-heart-pulse"></i> Health Status</h3>
          <canvas id="healthChart"></canvas>
        </div>
        <!-- Row 2: Timeline + Activity Log -->
        <div class="chart-card chart-timeline" data-widget-id="timeline" draggable="true">
          <div class="widget-drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></div>
          <h3><i class="fa-solid fa-chart-bar"></i> Expiry Timeline</h3>
          <canvas id="timelineChart"></canvas>
        </div>
        <div class="chart-card chart-card-activity" data-widget-id="activity" draggable="true">
          <div class="widget-drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></div>
          <h3><i class="fa-solid fa-clock-rotate-left"></i> Activity Log</h3>
          <div id="activityLog" class="activity-log-list"></div>
        </div>
      </div>
    </section>

    <!-- Quick Actions Bar -->
    <section class="quick-actions">
      <div class="add-domain-inline">
        <input id="domainInput" placeholder="Enter domain name (e.g., example.com)" autocomplete="off">
        <select id="addDomainGroup" class="add-domain-select" title="Assign to group (optional)">
          <option value="">No Group</option>
        </select>
        <select id="addDomainTag" class="add-domain-select" title="Add tag (optional)">
          <option value="">No Tag</option>
        </select>
        <button class="btn btn-add" onclick="addDomain()">
          <i class="fa-solid fa-plus"></i> Add
        </button>
        <button class="btn btn-toggle" onclick="toggleBulkUpload()" title="Add multiple domains">
          <i class="fa-solid fa-layer-group"></i>
        </button>
      </div>
    </section>

    <!-- Bulk Upload (hidden by default) -->
    <section id="bulkContainer" class="bulk-container" style="display: none;">
      <textarea id="bulkInput" placeholder="Enter domains separated by commas or new lines:&#10;example.com&#10;anotherdomain.net&#10;mysite.org"></textarea>
      <div class="bulk-actions">
        <button class="btn btn-add" onclick="addBulkDomains()">
          <i class="fa-solid fa-plus"></i> Add Domains
        </button>
        <button class="btn" onclick="toggleBulkUpload()">Cancel</button>
      </div>
    </section>


<!-- Filter Controls -->
<section class="filter-controls">
  <div class="filter-row">
    <!-- Search -->
    <div class="filter-group">
      <label for="searchInput">
        <i class="fa-solid fa-magnifying-glass"></i> Search
      </label>
      <input
        id="searchInput"
        type="text"
        placeholder="Search domains, registrars, nameservers..."
        autocomplete="off"
      >
    </div>

    <!-- Status Filter -->
    <div class="filter-group">
      <label for="filterStatus">
        <i class="fa-solid fa-filter"></i> Status
      </label>
      <select id="filterStatus">
        <option value="all">All Statuses</option>
        <option value="expired">Expired</option>
        <option value="expiring30">Expiring in 30 days</option>
        <option value="expiring90">Expiring in 90 days</option>
        <option value="expiring180">Expiring in 180 days</option>
        <option value="safe">Safe (>180 days)</option>
        <option value="error">Has Errors</option>
        <option value="unchecked">Never Checked</option>
      </select>
    </div>

    <!-- Registrar Filter -->
    <div class="filter-group">
      <label for="filterRegistrar">
        <i class="fa-solid fa-building"></i> Registrar
      </label>
      <select id="filterRegistrar">
        <option value="all">All Registrars</option>
        <!-- Populated dynamically -->
      </select>
    </div>

    <!-- Group Filter -->
    <div class="filter-group">
      <label for="filterGroup">
        <i class="fa-solid fa-folder"></i> Group
      </label>
      <select id="filterGroup">
        <option value="all">All Groups</option>
        <!-- Populated dynamically -->
      </select>
    </div>

<!-- Sort By -->
    <div class="filter-group">
      <label for="sortBy">
        <i class="fa-solid fa-arrow-down-a-z"></i> Sort By
      </label>
      <select id="sortBy">
        <option value="expiry">Expiry Date</option>
        <option value="domain">Domain Name</option>
        <option value="registrar">Registrar</option>
        <option value="age">Domain Age</option>
        <option value="lastChecked">Last Checked</option>
      </select>
    </div>

    <!-- Sort Order -->
    <div class="filter-group">
      <label for="sortOrder">
        <i class="fa-solid fa-sort"></i> Order
      </label>
      <select id="sortOrder">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>
    </div>

    <div class="filter-group">
      <button class="btn btn-sm" onclick="openTimelineChart()" title="View expiration timeline" id="timelineBtn">
        <i class="fa-solid fa-timeline"></i> Timeline
      </button>
    </div>

        <!-- Clear Filters -->
    <div class="filter-group filter-actions">
      <button class="btn btn-clear" onclick="clearFilters()">
        <i class="fa-solid fa-filter-circle-xmark"></i> Clear Filters
      </button>
    </div>
  </div>

</section>

    <!-- Bulk Actions Bar (hidden by default) -->
    <section id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
      <div class="bulk-actions-left">
        <span id="selectedCount">0 selected</span>
      </div>
      <div class="bulk-actions-right">
        <button class="btn btn-primary" onclick="openBulkOpsModal()">
          <i class="fa-solid fa-layer-group"></i> Bulk Operations
        </button>
        <button class="btn btn-bulk-refresh" onclick="refreshSelected()">
          <i class="fa-solid fa-arrows-rotate"></i> Refresh
        </button>
        <button class="btn btn-bulk-delete" onclick="deleteSelected()">
          <i class="fa-solid fa-trash"></i> Delete
        </button>
        <button class="btn btn-clear-selection" onclick="clearSelection()">
          <i class="fa-solid fa-xmark"></i> Clear
        </button>
      </div>
    </section>

    <!-- Domain Table -->
    <section class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th class="checkbox-col"><input type="checkbox" id="selectAll" title="Select all"></th>
            <th class="sortable-header" data-sort="domain">Domain</th>
            <th class="uptime-col">Uptime</th>
            <th>Health</th>
            <th class="sortable-header" data-sort="registrar">Registrar</th>
            <th class="sortable-header" data-sort="expiry">Expires</th>
            <th>Days Left</th>
            <th>Name Servers</th>
            <th class="ns-status-col">NS Status</th>
            <th class="sortable-header" data-sort="lastChecked">Last Check</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody id="table"></tbody>
      </table>
    </section>

    <!-- Pagination Controls -->
    <section class="pagination-controls" id="paginationControls" style="display: none;">
      <div class="pagination-info">
        <span id="paginationInfo">Showing 0 of 0 domains</span>
      </div>
      <div class="pagination-nav">
        <button class="btn btn-pagination" id="paginationFirst" onclick="goToPage(1)" title="First page">
          <i class="fa-solid fa-angles-left"></i>
        </button>
        <button class="btn btn-pagination" id="paginationPrev" onclick="goToPage(state.pagination.page - 1)" title="Previous page">
          <i class="fa-solid fa-angle-left"></i>
        </button>
        <div class="pagination-pages" id="paginationPages">
          <!-- Page numbers generated dynamically -->
        </div>
        <button class="btn btn-pagination" id="paginationNext" onclick="goToPage(state.pagination.page + 1)" title="Next page">
          <i class="fa-solid fa-angle-right"></i>
        </button>
        <button class="btn btn-pagination" id="paginationLast" onclick="goToPage(state.pagination.totalPages)" title="Last page">
          <i class="fa-solid fa-angles-right"></i>
        </button>
      </div>
      <div class="pagination-jump">
        <label for="pageJumpInput">Go to:</label>
        <input type="number" id="pageJumpInput" min="1" placeholder="#" style="width:54px;padding:4px 6px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;" onkeydown="if(event.key==='Enter'){jumpToPage(this.value);}">
        <button class="btn btn-pagination" onclick="jumpToPage(document.getElementById('pageJumpInput').value)" title="Go to page">Go</button>
      </div>
      <div class="pagination-size">
        <label for="pageSize">Per page:</label>
        <select id="pageSize" onchange="changePageSize(this.value)">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>
    </section>

  </div>

 <!-- Footer -->
  <footer class="footer">
    &copy; <span id="copyrightYear"></span> Domain Monitor. <span id="appVersion"></span>
  </footer>

  <!-- Notification container will be created by JavaScript -->


  <!-- Notification Sidebar -->
  <div id="notifSidebar" class="notif-sidebar">
    <div class="notif-sidebar-header">
      <h3><i class="fa-solid fa-bell"></i> Notifications</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-sm" onclick="markAllNotifsRead()" style="font-size:12px;padding:4px 8px;">Mark all read</button>
        <button class="notif-close" onclick="toggleNotificationSidebar()">&times;</button>
      </div>
    </div>
    <div class="notif-sidebar-body" id="notifList">
      <p class="notif-empty">No notifications yet.</p>
    </div>
  </div>
  <div id="notifOverlay" class="notif-overlay" onclick="toggleNotificationSidebar()"></div>

  <!-- Scripts -->
  <script src="app.js"></script>

</body>
</html>
